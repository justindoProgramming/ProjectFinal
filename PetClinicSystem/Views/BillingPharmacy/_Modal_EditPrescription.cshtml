@model PetClinicSystem.Models.Prescription
@using PetClinicSystem.Models
@using System.Linq
@using System.Collections.Generic

@{
    var pets = ViewBag.Pets as IEnumerable<Pet>;
    var staffList = ViewBag.Staff as IEnumerable<Account>;
    var drugs = ViewBag.Drugs as IEnumerable<Drug>;

    var dosageTypes = drugs
        .Select(d => d.DosageType)
        .Distinct()
        .OrderBy(t => t)
        .ToList();

    string dateString =
        Model.Date == default ? DateTime.Today.ToString("yyyy-MM-dd")
        : Model.Date.ToString("yyyy-MM-dd");

    // Make sure dropdowns keep existing values
    void EnsureOption(List<string> list, string value)
    {
        if (!string.IsNullOrWhiteSpace(value) && !list.Contains(value))
            list.Insert(0, value);
    }

    var dosageOptions = new List<string> { "0.5 tab", "1 tab", "2 tabs", "1 mL", "5 mL", "1 drop", "2 drops", "Apply thin layer", "See notes" };
    EnsureOption(dosageOptions, Model.Dosage);

    var freqOptions = new List<string> { "Once a day", "Twice a day", "Every 6 hours", "Every 8 hours", "As needed", "See notes" };
    EnsureOption(freqOptions, Model.Frequency);

    var durationOptions = new List<string> { "3 days", "5 days", "7 days", "14 days", "Until finished", "See notes" };
    EnsureOption(durationOptions, Model.Duration);
}

<div class="modal-header border-0">
    <h5 class="modal-title fw-bold">Edit Prescription</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>

<form id="editPrescriptionForm"
      method="post"
      action="@Url.Action("EditPrescription", "BillingPharmacy")">

    <input asp-for="PrescriptionId" type="hidden" />

    <div class="modal-body">
        <div class="row g-3">

            <!-- PET -->
            <div class="col-md-8">
                <label class="form-label fw-semibold">Pet</label>
                <select asp-for="PetId" class="form-select" required>
                    @foreach (var p in pets)
                    {
                        <option value="@p.PetId">@p.Name (@p.Owner.FullName)</option>
                    }
                </select>
            </div>

            <!-- DATE -->
            <div class="col-md-4">
                <label class="form-label fw-semibold">Date</label>
                <input type="date" asp-for="Date" value="@dateString" class="form-control" required />
            </div>

            <!-- DOCTOR -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Doctor</label>
                <select asp-for="StaffId" class="form-select" required>
                    @foreach (var s in staffList)
                    {
                        <option value="@s.AccountId">@s.FullName</option>
                    }
                </select>
            </div>

            <!-- FILTER -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Filter dosage type</label>
                <select id="dosageFilterEdit" class="form-select">
                    <option value="">All types</option>
                    @foreach (var t in dosageTypes)
                    {
                        <option value="@t">@t</option>
                    }
                </select>
            </div>

            <!-- DRUG SELECT -->
            <div class="col-md-8">
                <label class="form-label fw-semibold">Medication from Inventory</label>
                <select asp-for="SelectedDrugId"
                        id="drugSelectEdit"
                        class="form-select">

                    <option value="">No linked drug (manual medication)</option>

                    @foreach (var d in drugs)
                    {
                        <option value="@d.DrugId"
                                data-name="@d.DrugName"
                                data-dosage="@d.DosageType"
                                data-qty="@d.Quantity"
                                data-exp="@d.ExpiryDate.ToString("yyyy-MM-dd")"
                                data-min="@d.MinimumStock">
                            @d.DrugName (@d.DosageType) - ₱@d.UnitPrice.ToString("0.00")
                        </option>
                    }
                </select>
            </div>

            <div class="col-md-4">
                <label class="form-label fw-semibold">Dispense Qty</label>
                <input asp-for="DispensedQuantity" type="number" min="1" class="form-control" />
            </div>

            <!-- MED TEXT -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Medication (text)</label>
                <input asp-for="Medication" id="medTextEdit" class="form-control" required />
            </div>

            <!-- DOSAGE -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Dosage</label>
                <select asp-for="Dosage" class="form-select" required>
                    @foreach (var opt in dosageOptions)
                    {
                        <option value="@opt">@opt</option>
                    }
                </select>
            </div>

            <!-- FREQUENCY -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Dosage Interval</label>
                <select asp-for="Frequency" class="form-select" required>
                    @foreach (var opt in freqOptions)
                    {
                        <option value="@opt">@opt</option>
                    }
                </select>
            </div>

            <!-- DURATION -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Duration</label>
                <select asp-for="Duration" class="form-select" required>
                    @foreach (var opt in durationOptions)
                    {
                        <option value="@opt">@opt</option>
                    }
                </select>
            </div>

            <!-- NOTES -->
            <div class="col-12">
                <label class="form-label fw-semibold">Notes</label>
                <textarea asp-for="Notes" rows="3" class="form-control"></textarea>
            </div>

        </div>
    </div>

    <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Save Changes</button>
    </div>

</form>

<!-- ========================================================= -->
<!-- 🔥 SCRIPT – VALIDATION + TOAST ALERTS FOR EDIT MODAL     -->
<!-- ========================================================= -->
<script>
    (function () {

        const filter = document.getElementById("dosageFilterEdit");
        const drugSelect = document.getElementById("drugSelectEdit");
        const medText = document.getElementById("medTextEdit");

        const allOptions = Array.from(drugSelect.options);

        // Filter by dosage
        filter.addEventListener("change", () => {
            const type = filter.value;

            drugSelect.innerHTML = "";
            drugSelect.appendChild(allOptions[0]);

            allOptions.slice(1).forEach(opt => {
                const dType = opt.dataset.dosage;
                if (!type || dType === type) drugSelect.appendChild(opt);
            });
        });

        // Validation + toast warnings
        drugSelect.addEventListener("change", () => {

            const opt = drugSelect.options[drugSelect.selectedIndex];
            if (!opt || !opt.value) return;

            const name = opt.dataset.name;
            const type = opt.dataset.dosage;
            const qty = parseInt(opt.dataset.qty);
            const min = parseInt(opt.dataset.min);
            const exp = new Date(opt.dataset.exp);
            const today = new Date();
            const soon = new Date();
            soon.setDate(today.getDate() + 30);

            medText.value = `${name} (${type})`;

            // ❌ EXPIRED
            if (exp < today) {
                showBpToast(`❌ ${name} is EXPIRED (${opt.dataset.exp})`, "error");
                drugSelect.value = "";
                medText.value = "";
                return;
            }

            // ❌ OUT OF STOCK
            if (qty <= 0) {
                showBpToast(`❌ ${name} is OUT OF STOCK`, "error");
                drugSelect.value = "";
                medText.value = "";
                return;
            }

            // ⚠ LOW STOCK
            if (qty <= min) {
                showBpToast(`⚠ Low stock: Only ${qty} left.`, "warning");
            }

            // ⚠ EXPIRING SOON
            if (exp <= soon) {
                showBpToast(`⚠ ${name} expires soon (${opt.dataset.exp})`, "warning");
            }

        });

    })();
</script>
