@model PetClinicSystem.Models.Prescription
@using PetClinicSystem.Models
@using System.Linq

@{
    var pets = ViewBag.Pets as IEnumerable<Pet> ?? Enumerable.Empty<Pet>();
    var staff = ViewBag.Staff as IEnumerable<Account> ?? Enumerable.Empty<Account>();
    var drugs = ViewBag.Drugs as IEnumerable<Drug> ?? Enumerable.Empty<Drug>();

    var dosageTypes = drugs
        .Select(d => d.DosageType)
        .Where(t => !string.IsNullOrEmpty(t))
        .Distinct()
        .OrderBy(t => t)
        .ToList();

    string dateString =
        Model.Date == default ? DateTime.Today.ToString("yyyy-MM-dd")
        : Model.Date.ToString("yyyy-MM-dd");
}

<div class="modal-header border-0">
    <h5 class="modal-title fw-bold">New Prescription</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>

<form id="createPrescriptionForm"
      method="post"
      action="@Url.Action("CreatePrescription", "BillingPharmacy")">

    <div class="modal-body">
        <div class="row g-3">

            <!-- PET -->
            <div class="col-md-8">
                <label class="form-label fw-semibold">Pet</label>

                <!-- lightweight filter -->
                <input id="petFilter" class="form-control mb-2" placeholder="Type to filter pets (code or name)..." autocomplete="off" />

                <select id="petSelect" asp-for="PetId" class="form-select" required>
                    <option value="">Select pet…</option>
                    @foreach (var p in pets)
                    {
                        <option value="@p.PetId">@p.PetCode - @p.Name (@p.Owner?.FullName)</option>
                    }
                </select>
            </div>

            <!-- DATE -->
            <div class="col-md-4">
                <label class="form-label fw-semibold">Date</label>
                <input type="date" asp-for="Date" value="@dateString" class="form-control" required />
            </div>

            <!-- STAFF (Doctor) -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Doctor</label>

                <!-- lightweight filter -->
                <input id="staffFilter" class="form-control mb-2" placeholder="Type to filter doctors..." autocomplete="off" />

                <select id="staffSelect" asp-for="StaffId" class="form-select" required>
                    <option value="">Select doctor…</option>
                    @* Hide system admin (IsAdmin == 1) *@
                    @foreach (var s in staff)
                    {
                        if (s.IsAdmin != 1)
                        {
                            <option value="@s.AccountId">@s.FullName</option>
                        }
                    }
                </select>
            </div>

            <!-- DOSAGE TYPE FILTER -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Filter by dosage type</label>
                <select id="dosageFilter" class="form-select">
                    <option value="">All types</option>
                    @foreach (var t in dosageTypes)
                    {
                        <option value="@t">@t</option>
                    }
                </select>
            </div>

            <!-- DRUG SELECT -->
            <div class="col-md-8">
                <label class="form-label fw-semibold">Medication from Inventory</label>
                <select asp-for="SelectedDrugId"
                        id="drugSelect"
                        class="form-select">

                    <option value="">No linked drug (manual)</option>

                    @foreach (var d in drugs)
                    {
                        <option value="@d.DrugId"
                                data-name="@d.DrugName"
                                data-dosage="@d.DosageType"
                                data-qty="@d.Quantity"
                                data-exp="@d.ExpiryDate.ToString("yyyy-MM-dd")"
                                data-min="@d.MinimumStock">
                            @d.DrugName (@d.DosageType) - ₱@d.UnitPrice.ToString("0.00")
                        </option>
                    }
                </select>
            </div>

            <!-- DISPENSE QTY -->
            <div class="col-md-4">
                <label class="form-label fw-semibold">Dispense Qty</label>
                <input asp-for="DispensedQuantity"
                       type="number"
                       min="1"
                       class="form-control"
                       placeholder="Units" />
            </div>

            <!-- MEDICATION TEXT -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Medication (text)</label>
                <input asp-for="Medication" id="medText" class="form-control" required />
            </div>

            <!-- DOSAGE -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Dosage</label>
                <select asp-for="Dosage" class="form-select" required>
                    <option value="">Select…</option>
                    <option>0.5 tab</option>
                    <option>1 tab</option>
                    <option>2 tabs</option>
                    <option>1 mL</option>
                    <option>5 mL</option>
                    <option>1 drop</option>
                    <option>2 drops</option>
                </select>
            </div>

            <!-- DOSAGE INTERVAL -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Dosage Interval</label>
                <select asp-for="Frequency" class="form-select" required>
                    <option value="">Select…</option>
                    <option>Once a day</option>
                    <option>Twice a day</option>
                    <option>Every 6 hours</option>
                    <option>Every 8 hours</option>
                    <option>As needed</option>
                </select>
            </div>

            <!-- DURATION -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Duration</label>
                <select asp-for="Duration" class="form-select" required>
                    <option value="">Select…</option>
                    <option>3 days</option>
                    <option>5 days</option>
                    <option>7 days</option>
                    <option>14 days</option>
                </select>
            </div>

            <!-- NOTES -->
            <div class="col-12">
                <label class="form-label fw-semibold">Notes</label>
                <textarea asp-for="Notes" rows="3" class="form-control"></textarea>
            </div>

        </div>
    </div>

    <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Save Prescription</button>
    </div>

</form>

<script>
    (function () {
        // Expose init function for AJAX callers
        window.initPrescriptionFilters = initPrescriptionFilters;

        function initPrescriptionFilters() {
            setupSelectFilter('petFilter', 'petSelect', 'Type to filter pets (code or name)...');
            setupSelectFilter('staffFilter', 'staffSelect', 'Type to filter doctors...');
            initDrugDosageFilter();
            initDrugValidation();
        }

        // Generic lightweight select filter
        function setupSelectFilter(filterId, selectId, placeholder) {
            var select = document.getElementById(selectId);
            if (!select) return;

            // Prevent duplicate initialization
            if (select._filterInitialized) return;

            var filter = document.getElementById(filterId);
            if (!filter) {
                var input = document.createElement('input');
                input.id = filterId;
                input.className = 'form-control mb-2';
                input.placeholder = placeholder || 'Type to filter...';
                input.autocomplete = 'off';
                select.parentNode.insertBefore(input, select);
                filter = input;
            }

            // Save original options once
            if (!select._origOptions) {
                select._origOptions = Array.from(select.options).map(function (o) {
                    return { value: o.value, text: o.text, selected: o.selected, disabled: o.disabled };
                });
            }

            function build(q) {
                q = (q || '').trim().toLowerCase();
                var prevValue = select.value;
                select.innerHTML = '';

                // Keep placeholder
                var placeholderOpt = select._origOptions.find(function (o) { return o.value === ""; });
                if (placeholderOpt) {
                    var ph = document.createElement('option');
                    ph.value = "";
                    ph.textContent = placeholderOpt.text;
                    select.appendChild(ph);
                }

                var matches = select._origOptions.filter(function (o) {
                    if (!o.value) return false;
                    if (!q) return true;
                    return o.text.toLowerCase().includes(q);
                });

                if (matches.length === 0) {
                    var none = document.createElement('option');
                    none.value = "";
                    none.textContent = "No matches";
                    none.disabled = true;
                    select.appendChild(none);
                    return;
                }

                matches.forEach(function (o) {
                    var opt = document.createElement('option');
                    opt.value = o.value;
                    opt.textContent = o.text;
                    // restore selection
                    if (o.value === prevValue) opt.selected = true;
                    else if (!prevValue && o.selected) opt.selected = true;
                    if (o.disabled) opt.disabled = true;
                    select.appendChild(opt);
                });
            }

            var timer = null;
            filter.addEventListener('input', function () {
                clearTimeout(timer);
                timer = setTimeout(function () {
                    build(filter.value);
                }, 120);
            });

            filter.addEventListener('keydown', function (e) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    select.focus();
                }
            });

            select._filterInitialized = true;
            // initial build
            build(filter.value);
        }

        // Dosage filter for drugs
        function initDrugDosageFilter() {
            var drugSelect = document.getElementById('drugSelect');
            var dosageFilter = document.getElementById('dosageFilter');
            if (!drugSelect || !dosageFilter) return;

            // keep original drug options once
            if (!drugSelect._origOptions) {
                drugSelect._origOptions = Array.from(drugSelect.options).map(function (o) {
                    return { value: o.value, text: o.text, dataset: Object.assign({}, o.dataset) };
                });
            }

            dosageFilter.addEventListener('change', function () {
                var type = dosageFilter.value;
                // rebuild
                drugSelect.innerHTML = '';
                // placeholder
                var first = drugSelect._origOptions[0];
                if (first) {
                    var ph = document.createElement('option');
                    ph.value = first.value;
                    ph.textContent = first.text;
                    drugSelect.appendChild(ph);
                }

                drugSelect._origOptions.slice(1).forEach(function (o) {
                    var dType = o.dataset.dosage || '';
                    if (!type || type === dType) {
                        var opt = document.createElement('option');
                        opt.value = o.value;
                        opt.textContent = o.text;
                        // copy dataset back if needed (not straightforward here, but we use data attributes originally present)
                        selectAppendCopyDataAttributes(opt, o.dataset);
                        drugSelect.appendChild(opt);
                    }
                });
            });
        }

        // Helper to copy dataset fields safely (used when rebuilding drug options)
        function selectAppendCopyDataAttributes(optElement, dataset) {
            if (!dataset) return;
            for (var k in dataset) {
                if (dataset.hasOwnProperty(k)) {
                    optElement.setAttribute('data-' + k, dataset[k]);
                }
            }
        }

        // Drug change validation / toast helpers
        function initDrugValidation() {
            var drugSelect = document.getElementById('drugSelect');
            var medText = document.getElementById('medText');

            function showBpToast(message, type) {
                // Use existing showPublicToast if available
                try {
                    if (typeof showPublicToast === 'function') {
                        showPublicToast(message, type === 'error' ? 'error' : (type === 'warning' ? 'warning' : 'success'));
                        return;
                    }
                } catch (e) { /* ignore */ }
                // Fallback
                alert(message);
            }

            if (!drugSelect) return;

            // Save original options (if not saved already)
            if (!drugSelect._origOptions) {
                drugSelect._origOptions = Array.from(drugSelect.options).map(function (o) {
                    // store data attrs
                    var ds = {};
                    Array.prototype.slice.call(o.attributes).forEach(function (attr) {
                        if (attr.name.indexOf('data-') === 0) {
                            ds[attr.name.substring(5)] = attr.value;
                        }
                    });
                    return { value: o.value, text: o.text, dataset: ds };
                });
            }

            drugSelect.addEventListener('change', function () {
                var opt = drugSelect.options[drugSelect.selectedIndex];
                if (!opt || !opt.value) return;

                var name = opt.dataset.name;
                var type = opt.dataset.dosage;
                var qty = parseInt(opt.dataset.qty || "0", 10);
                var min = parseInt(opt.dataset.min || "0", 10);
                var expRaw = opt.dataset.exp;
                var exp = expRaw ? new Date(expRaw + "T00:00:00") : null;
                var today = new Date();
                var soon = new Date();
                soon.setDate(today.getDate() + 30);

                // Auto-fill medication text
                if (medText) medText.value = name + (type ? ' (' + type + ')' : '');

                // Expiry check
                if (exp && exp < today) {
                    showBpToast(name + ' is expired (' + expRaw + ')', 'error');
                    drugSelect.value = "";
                    if (medText) medText.value = "";
                    return;
                }

                // Out of stock
                if (qty <= 0) {
                    showBpToast(name + ' is out of stock', 'error');
                    drugSelect.value = "";
                    if (medText) medText.value = "";
                    return;
                }

                // Low stock
                if (qty <= min) {
                    showBpToast('Low stock: Only ' + qty + ' left.', 'warning');
                }

                // Expiring soon
                if (exp && exp <= soon) {
                    showBpToast(name + ' expires soon (' + expRaw + ')', 'warning');
                }
            });
        }

        // Initialize on insert
        initPrescriptionFilters();

        // Re-init if modal shown (covers cases where partial inserted before modal shown)
        document.addEventListener('shown.bs.modal', function (e) {
            var modal = e.target;
            if (!modal) return;
            if (modal.querySelector('#petSelect') || modal.querySelector('#staffSelect') || modal.querySelector('#drugSelect')) {
                initPrescriptionFilters();
            }
        });

    })();
</script>
