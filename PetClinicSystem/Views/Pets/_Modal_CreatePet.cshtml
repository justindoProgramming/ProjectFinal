@model PetClinicSystem.Models.Pet
@{
    var owners = ViewBag.Owners as List<PetClinicSystem.Models.Owner> ?? new List<PetClinicSystem.Models.Owner>();
    bool ownerLocked = (ViewBag.OwnerLocked == true);
    var currentOwner = ownerLocked ? owners.FirstOrDefault() : null;

    // initial breed value to pre-select in JS
    string initialBreed = Model?.Breed ?? "";
    // BirthDate default handling
    var birthStr = Model?.BirthDate == null || Model.BirthDate == default(System.DateTime)
        ? ""
        : Model.BirthDate.ToString("yyyy-MM-dd");
}

<div class="modal-header">
    <h5 class="modal-title fw-bold">Add New Pet</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form asp-controller="Pets"
      asp-action="Create"
      method="post">
    @Html.AntiForgeryToken()

    <div class="modal-body">
        <div class="row g-3">

            <!-- OWNER (left) -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Owner</label>

                @if (ownerLocked)
                {
                    <!-- Hidden OwnerId (submitted) -->
                    <input type="hidden" name="OwnerId" value="@(currentOwner?.OwnerId ?? 0)" />

                    <!-- Readonly display with small '(You)' badge -->
                    <div class="input-group">
                        <input type="text"
                               class="form-control"
                               value='@(currentOwner?.FullName ?? "Owner not found")'
                               readonly />
                        <span class="input-group-text text-muted">You</span>
                    </div>
                }
                else
                {
                    <!-- Inline lightweight filter for owners -->
                    <input id="ownerFilter" class="form-control mb-2" placeholder="Type to filter owners..." autocomplete="off" />

                    <select id="ownerSelect" asp-for="OwnerId" class="form-select" required>
                        <option value="">Select owner...</option>
                        @foreach (var o in owners)
                        {
                            <option value="@o.OwnerId">@o.FullName</option>
                        }
                    </select>
                }

                <span asp-validation-for="OwnerId" class="text-danger"></span>
            </div>

            <!-- PET NAME (right) -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Pet Name</label>
                <input asp-for="Name"
                       class="form-control"
                       placeholder="e.g., Buddy, Luna"
                       required />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <!-- SPECIES -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Species</label>
                <select asp-for="Species"
                        class="form-select"
                        id="speciesSelectCreate"
                        required>
                    <option value="">Select species...</option>
                    <option value="Dog">Dog</option>
                    <option value="Cat">Cat</option>
                </select>
                <span asp-validation-for="Species" class="text-danger"></span>
            </div>

            <!-- BREED -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Breed</label>

                <div class="mb-2">
                    <input type="text"
                           id="breedSearchCreate"
                           class="form-control"
                           placeholder="Type to filter breeds..." />
                </div>

                <select asp-for="Breed"
                        id="breedSelectCreate"
                        class="form-select">
                    <option value="">Select breed...</option>
                </select>
                <span asp-validation-for="Breed" class="text-danger"></span>
            </div>

            <!-- SEX -->
            <div class="col-md-4">
                <label class="form-label fw-semibold">Sex</label>
                <select asp-for="Gender" class="form-select">
                    <option value="">Select gender...</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
                <span asp-validation-for="Gender" class="text-danger"></span>
            </div>

            <!-- BIRTHDATE -->
            <div class="col-md-4">
                <label class="form-label fw-semibold">Birthdate</label>
                <input asp-for="BirthDate"
                       class="form-control"
                       type="date"
                       value="@birthStr" />
                <span asp-validation-for="BirthDate" class="text-danger"></span>
            </div>

            <!-- WEIGHT -->
            <div class="col-md-4">
                <label class="form-label fw-semibold">Weight (kg)</label>
                <input asp-for="Weight"
                       type="number"
                       step="0.01"
                       min="0"
                       class="form-control"
                       placeholder="e.g., 5.50" />
                <span asp-validation-for="Weight" class="text-danger"></span>
            </div>

            <!-- COLOR / MARKINGS -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Color / Markings</label>
                <select asp-for="ColorMarkings"
                        id="colorSelectCreate"
                        class="form-select">
                    <option value="">Select color / markings...</option>
                    <option value="Black">Black</option>
                    <option value="White">White</option>
                    <option value="Brown">Brown</option>
                    <option value="Gray">Gray</option>
                    <option value="Orange">Orange</option>
                    <option value="Black and White">Black and White</option>
                    <option value="Brown and White">Brown and White</option>
                    <option value="Tricolor">Tricolor</option>
                    <option value="Spotted">Spotted</option>
                    <option value="Striped">Striped</option>
                    <option value="Solid Color">Solid Color</option>
                    <option value="Mixed">Mixed</option>
                </select>
                <span asp-validation-for="ColorMarkings" class="text-danger"></span>
            </div>

            <!-- MEDICAL HISTORY -->
            <div class="col-md-6">
                <label class="form-label fw-semibold">Medical History / Notes</label>
                <textarea asp-for="MedicalHistory"
                          class="form-control"
                          rows="3"
                          placeholder="Previous conditions, allergies, etc."></textarea>
                <span asp-validation-for="MedicalHistory" class="text-danger"></span>
            </div>

        </div>
    </div>

    <div class="modal-footer">
        <button type="button"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal">
            Cancel
        </button>
        <button type="submit" class="btn btn-success">
            Save Pet
        </button>
    </div>
</form>

<script>
    (function () {
        const dogBreeds = [
            "Aspin",
            "Shih Tzu",
            "Labrador Retriever",
            "Golden Retriever",
            "German Shepherd",
            "Poodle",
            "Bulldog",
            "Beagle",
            "Pug",
            "Siberian Husky",
            "Chihuahua",
            "Dalmatian",
            "Mixed Breed"
        ];

        const catBreeds = [
            "Domestic Shorthair",
            "Domestic Longhair",
            "Persian",
            "Siamese",
            "Maine Coon",
            "Ragdoll",
            "British Shorthair",
            "Scottish Fold",
            "Bengal",
            "Mixed Breed"
        ];

        // Generic lightweight select filter (used for owner)
        function setupSelectFilter(filterId, selectId) {
            const filter = document.getElementById(filterId);
            const select = document.getElementById(selectId);
            if (!filter || !select) return;

            // store original options
            if (!select._origOptions) {
                select._origOptions = Array.from(select.options).map(function (o) {
                    return { value: o.value, text: o.text, selected: o.selected, disabled: o.disabled };
                });
            }

            function build(q) {
                q = (q || '').trim().toLowerCase();
                select.innerHTML = '';

                // keep placeholder
                const placeholder = select._origOptions.find(o => o.value === "");
                if (placeholder) {
                    const ph = document.createElement('option');
                    ph.value = "";
                    ph.textContent = placeholder.text;
                    select.appendChild(ph);
                }

                const matches = select._origOptions.filter(o => {
                    if (!o.value) return false;
                    if (!q) return true;
                    return o.text.toLowerCase().includes(q);
                });

                if (matches.length === 0) {
                    const none = document.createElement('option');
                    none.value = "";
                    none.textContent = "No matches";
                    none.disabled = true;
                    select.appendChild(none);
                    return;
                }

                matches.forEach(o => {
                    const opt = document.createElement('option');
                    opt.value = o.value;
                    opt.textContent = o.text;
                    if (o.selected) opt.selected = true;
                    if (o.disabled) opt.disabled = true;
                    select.appendChild(opt);
                });
            }

            // debounce input
            let timer = null;
            filter.addEventListener('input', function () {
                clearTimeout(timer);
                timer = setTimeout(function () {
                    build(filter.value);
                }, 120);
            });

            // arrow down jumps into select
            filter.addEventListener('keydown', function (e) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    select.focus();
                }
            });

            // initial
            build(filter.value);
        }

        // Setup owner filter if present (not shown when ownerLocked)
        (function initOwnerFilter() {
            const ownerFilter = document.getElementById('ownerFilter');
            const ownerSelect = document.getElementById('ownerSelect');
            if (ownerFilter && ownerSelect) {
                setupSelectFilter('ownerFilter', 'ownerSelect');
            }
        })();


        // Breed helper (same as before)
        (function initBreedHelpers() {
            const speciesSelect = document.getElementById("speciesSelectCreate");
            const breedSelect = document.getElementById("breedSelectCreate");
            const breedSearch = document.getElementById("breedSearchCreate");

            function getSource(species) {
                if (species === "Dog") return dogBreeds;
                if (species === "Cat") return catBreeds;
                return [];
            }

            function refreshBreeds() {
                if (!breedSelect) return;

                const species = speciesSelect ? speciesSelect.value : "";
                const query = (breedSearch ? breedSearch.value : "").toLowerCase();

                const source = getSource(species);
                breedSelect.innerHTML = '<option value="">Select breed...</option>';

                source
                    .filter(b => b.toLowerCase().includes(query))
                    .forEach(b => {
                        const opt = document.createElement("option");
                        opt.value = b;
                        opt.textContent = b;
                        breedSelect.appendChild(opt);
                    });
            }

            if (speciesSelect) {
                speciesSelect.addEventListener("change", refreshBreeds);
            }
            if (breedSearch) {
                breedSearch.addEventListener("input", refreshBreeds);
            }

            // initial call
            refreshBreeds();
        })();

    })();
</script>
