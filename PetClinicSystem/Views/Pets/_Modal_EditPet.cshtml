@model PetClinicSystem.Models.Pet
@using PetClinicSystem.Models
@using System.Text.Json

@{
    var owners = ViewBag.Owners as List<Owner> ?? new List<Owner>();
    bool ownerLocked = (ViewBag.OwnerLocked == true);
    var currentOwner = ownerLocked ? owners.FirstOrDefault() : null;

    // initial breed value for JS (JSON-encoded to be safe)
    var initialBreed = Model?.Breed ?? "";
    var initialBreedJson = JsonSerializer.Serialize(initialBreed);

    // Birthdate formatted for input[type=date]
    var birthStr = Model?.BirthDate == null || Model.BirthDate == default(DateTime)
        ? ""
        : Model.BirthDate.ToString("yyyy-MM-dd");
}

<div class="modal-header">
    <h5 class="modal-title fw-bold">Edit Pet</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form asp-controller="Pets" asp-action="Edit" method="post">
    @Html.AntiForgeryToken()
    <input asp-for="PetId" type="hidden" />

    <div class="modal-body">
        <div class="container-fluid">
            <div class="row g-3">

                <!-- OWNER (locked for clients) -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Owner</label>

                    @if (ownerLocked)
                    {
                        <!-- Hidden OwnerId for submission -->
                        <input type="hidden" name="OwnerId" value="@(currentOwner?.OwnerId ?? 0)" />
                        <div class="input-group">
                            <input type="text" class="form-control" value='@(currentOwner?.FullName ?? "Owner not found")' readonly />
                            <span class="input-group-text text-muted">You</span>
                        </div>
                    }
                    else
                    {
                        <select asp-for="OwnerId" class="form-select" required>
                            <option value="">Select owner...</option>
                            @foreach (var o in owners)
                            {
                                <option value="@o.OwnerId">@o.FullName</option>
                            }
                        </select>
                    }

                    <span asp-validation-for="OwnerId" class="text-danger small"></span>
                </div>

                <!-- PET CODE (read-only) -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Pet Code</label>
                    <input class="form-control" value="@Model.PetCode" readonly />
                </div>

                <!-- PET NAME -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Pet Name</label>
                    <input asp-for="Name" class="form-control" placeholder="e.g., Buddy, Luna" required />
                    <span asp-validation-for="Name" class="text-danger small"></span>
                </div>

                <!-- SPECIES: Dog / Cat -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Species</label>
                    <select asp-for="Species" class="form-select" id="speciesSelectEdit" required>
                        <option value="">Select species...</option>
                        <option value="Dog">Dog</option>
                        <option value="Cat">Cat</option>
                    </select>
                    <span asp-validation-for="Species" class="text-danger small"></span>
                </div>

                <!-- BREED: Search + Select, filtered by species -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Breed</label>
                    <input type="text" id="breedSearchEdit" class="form-control mb-2" placeholder="Type to filter breeds..." />
                    <select asp-for="Breed" id="breedSelectEdit" class="form-select" data-current-breed='@Html.Raw(initialBreedJson)'>
                        <option value="">Select breed...</option>
                    </select>
                    <span asp-validation-for="Breed" class="text-danger small"></span>
                </div>

                <!-- GENDER -->
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Sex</label>
                    <select asp-for="Gender" class="form-select">
                        <option value="">Select gender...</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                    <span asp-validation-for="Gender" class="text-danger small"></span>
                </div>

                <!-- BIRTHDATE -->
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Birthdate</label>
                    <input class="form-control" type="date" name="BirthDate" value="@birthStr" />
                    <span asp-validation-for="BirthDate" class="text-danger small"></span>
                </div>

                <!-- WEIGHT -->
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Weight (kg)</label>
                    <input asp-for="Weight" type="number" step="0.01" min="0" class="form-control" placeholder="e.g., 5.50" />
                    <span asp-validation-for="Weight" class="text-danger small"></span>
                </div>

                <!-- COLOR / MARKINGS -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Color / Markings</label>
                    <select asp-for="ColorMarkings" id="colorSelectEdit" class="form-select">
                        <option value="">Select color / markings...</option>
                        <option value="Black">Black</option>
                        <option value="White">White</option>
                        <option value="Brown">Brown</option>
                        <option value="Gray">Gray</option>
                        <option value="Orange">Orange</option>
                        <option value="Black and White">Black and White</option>
                        <option value="Brown and White">Brown and White</option>
                        <option value="Tricolor">Tricolor</option>
                        <option value="Spotted">Spotted</option>
                        <option value="Striped">Striped</option>
                        <option value="Solid Color">Solid Color</option>
                        <option value="Mixed">Mixed</option>
                      
                    </select>
                    <span asp-validation-for="ColorMarkings" class="text-danger small"></span>
                </div>

                <!-- MEDICAL HISTORY -->
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Medical History / Notes</label>
                    <textarea asp-for="MedicalHistory" class="form-control" rows="3" placeholder="Previous conditions, allergies, etc."></textarea>
                    <span asp-validation-for="MedicalHistory" class="text-danger small"></span>
                </div>

            </div>
        </div>
    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Changes</button>
    </div>
</form>

<script>
    (function () {
        const dogBreeds = [
            "Aspin","Shih Tzu","Labrador Retriever","Golden Retriever","German Shepherd",
            "Poodle","Bulldog","Beagle","Pug","Siberian Husky","Chihuahua","Dalmatian","Mixed Breed","Unknown"
        ];

        const catBreeds = [
            "Domestic Shorthair","Domestic Longhair","Persian","Siamese","Maine Coon",
            "Ragdoll","British Shorthair","Scottish Fold","Bengal","Mixed Breed","Unknown"
        ];

        const speciesSelect = document.getElementById("speciesSelectEdit");
        const breedSelect = document.getElementById("breedSelectEdit");
        const breedSearch = document.getElementById("breedSearchEdit");

        // read the initial breed from the data attribute (set server-side)
        const initialBreed = breedSelect ? (breedSelect.dataset.currentBreed || "") : "";

        function getSource(species) {
            if (species === "Dog") return dogBreeds;
            if (species === "Cat") return catBreeds;
            return [];
        }

        function refreshBreeds() {
            if (!breedSelect) return;
            const species = speciesSelect ? speciesSelect.value : "";
            const query = (breedSearch ? breedSearch.value : "").toLowerCase();
            const source = getSource(species);

            breedSelect.innerHTML = '<option value="">Select breed...</option>';

            source
                .filter(b => b.toLowerCase().includes(query))
                .forEach(b => {
                    const opt = document.createElement("option");
                    opt.value = b;
                    opt.textContent = b;
                    breedSelect.appendChild(opt);
                });

            // select initialBreed when present
            if (initialBreed) {
                // if option exists, set it; if not, append and select
                const found = Array.from(breedSelect.options).some(o => o.value === initialBreed);
                if (found) {
                    breedSelect.value = initialBreed;
                } else {
                    const opt = document.createElement("option");
                    opt.value = initialBreed;
                    opt.textContent = initialBreed;
                    opt.selected = true;
                    breedSelect.appendChild(opt);
                }
            }
        }

        if (speciesSelect) {
            speciesSelect.addEventListener("change", function () {
                // Clear initialBreed so we don't accidentally reset
                // when the user intentionally changes species
                // (we want new species breeds to appear)
                refreshBreeds();
            });
        }

        if (breedSearch) {
            breedSearch.addEventListener("input", refreshBreeds);
        }

        // initial populate
        refreshBreeds();
    })();
</script>
